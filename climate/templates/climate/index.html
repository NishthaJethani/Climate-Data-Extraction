<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Climate Data Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.12.1/plotly.min.js"></script>
    <style>
        #map { height: 400px; }
        #plot { width: 100%; height: 400px; }
    </style>
</head>
<body>
    <h2>Select Coordinates and Climate Variable</h2>

    <div id="map"></div>

    <br>
    Latitude: <input type="text" id="lat" placeholder="Latitude">
    Longitude: <input type="text" id="lon" placeholder="Longitude">
    <br><br>

    <label for="variable">Select Climate Variable:</label>
    <select id="variable">
        {% for variable in climate_variables %}
            <option value="{{ variable }}">{{ variable }}</option>
        {% endfor %}
    </select>
    <br><br>

    <button onclick="fetchData()">Plot Time Series</button>
    <button onclick="downloadCSV()">Download CSV</button>

    <div id="plot"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <script>
        // Initialize map
        var map = L.map('map').setView([25.0, 85.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Capture click event on map
        map.on('click', function(e) {
            document.getElementById('lat').value = e.latlng.lat.toFixed(5);
            document.getElementById('lon').value = e.latlng.lng.toFixed(5);
        });

        // Fetch and plot data
        function fetchData() {
            var lat = document.getElementById("lat").value;
            var lon = document.getElementById("lon").value;
            var variable = document.getElementById("variable").value;

            if (lat && lon && variable) {
                fetch(`/get_timeseries?lat=${lat}&lon=${lon}&variable=${variable}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            var dates = data.map(row => row.time);
                            var values = data.map(row => row[variable]);

                            var trace = {
                                x: dates,
                                y: values,
                                type: 'scatter'
                            };
                            var layout = {
                                title: `Time Series for ${variable}`,
                                xaxis: { title: 'Date' },
                                yaxis: { title: variable }
                            };

                            Plotly.newPlot('plot', [trace], layout);
                        }
                    })
                    .catch(error => alert('Error fetching data: ' + error));
            } else {
                alert('Please provide latitude, longitude, and select a variable.');
            }
        }

        // Download CSV data
        function downloadCSV() {
            var lat = document.getElementById("lat").value;
            var lon = document.getElementById("lon").value;
            var variable = document.getElementById("variable").value;

            if (lat && lon && variable) {
                window.location.href = `/download_csv?lat=${lat}&lon=${lon}&variable=${variable}`;
            } else {
                alert('Please provide latitude, longitude, and select a variable.');
            }
        }
    </script>
</body>
</html>
